## Python API Server

This is a simple auth server which uses Python's **Flask** web framework. It generates a `JWT` token using `RSA` algorithm. Here, I have used a sqllite database to store user information.

I have used [Postman](https://www.postman.com/) to send request to server and to also check the response of the server.

## Getting Started

### Install required packages
`pip install -r requirements.txt`

### Start the Flask server
```bash
python main.py
```

### Usage
1. First create a user by sending a **POST** request in the endpoint
    -  `http://localhost:5000/user`
    The body of request is in the following format
    ```
    {
        "email": "testuser@email.com",
        "name": "testuser",
        "password": "testuser"
       
    }
    ```
    - ##### Example:
    ![login](./images/create_user.PNG)

1. After creating user then the user can login by sending a **GET** request to this endpoint. ` http://localhost:5000/login` using the username and password. You can use [Postman](https://www.postman.com/) to do this.
    - Then it returns token in following format.
    ```
    {
    "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJwdWJsaWNfaWQiOiIxYjIzMjNmNS05N2U1LTQ2ZDItOTg2Yy1lYjRmMGE3MjdkZjcifQ.rzG8dYyKtQSJjiE3stp0ZhyHNKGrDbk6lex3unWoZLjAk9Gy2bmllVeXQE0eiJWtA3cu1conq7RTRyhuvKVeP_0cR8cG9j-_J9V3TsHOZj_f50EpyY6RLQWvSN25i5DtfA0A5pppLjjZutO9Qgy-AgVum7B4qeU6G_FwLkzgMLYHlLbEuwvvhIM0m3dI00MgbTU6Gj0tis3hIMUKQXZUJL9m4NXbGx3j3kMihI8HLQVV9anzHK18Om-Rk7AOOyrjG490RFH9TXBF4sIDFy5N9CccB1dKfINVRCfjeF0FVajoneSUQWrErQgvqX5PA1hnxtXj0LO3gZqIZtxQIfdxqg"
    }
    ```
    - ##### Example:
    ![create_user](./images/login.PNG)

    - This token is **required** to access other functionalities of the API such as *getting user info*.

1. To get the user profile send **GET** request to `http://localhost:5000/user/profile` along with the header containing the token. 
    - Respose is shown in the following format. It returns the details of the user who have sent the request.
    ```
        {
        "user": {
            "email": "testuser@eamil.com",
            "name": "testuser"
                }
        }
    ```
    - ##### Example
    ![get_user](./images/get_user.PNG)

### Code for generating and verifying token
The `jwt_helper.py` file contains the code for generating the private and public keys and also generating and verifying tokens.

The private and public keys are generated by using the following code.

```python
from jwcrypto import jwk
import jwt
from jwt import PyJWKClient
import json
def generate_key():
    key = jwk.JWK.generate(kty='RSA', size=2048, alg='RSA', use='enc', kid='12345')
    public_key = key.export_public()
    private_key = key.export_private()
    return private_key, public_key
```
The above code returns a **JSON Web Key (JWK)** for private and public key.

#### Generate Token
The **JWT** are generated by `generate_token()` function which takes *payload* as an argument and returns the *token* from encode in **RS256** algorithm. This function also saves the **JSON Web Key(JWK)** in **JSON Web Key Sets(JWKS)**.
```python
def generate_token(payload):
    private_key, public_key = generate_key()
    pk = jwt.algorithms.RSAAlgorithm.from_jwk(json.loads(private_key)) 
    token = jwt.encode(payload, pk, algorithm='RS256')
    jwks_dict = {}
    
    jwks_dict["keys"] = json.loads(public_key)
    with open('jwks.json', 'w') as f:
        json.dump(jwks_dict, f)
    return token
```
#### Expiration time of token 
The expiration time of the token can be set in the payload while generating the token. 
```
payload = {'public_id' : user.public_id, 'exp': datetime.datetime.utcnow() + datetime.timedelta(minutes=30)}
token = generate_token(payload)
```

#### Decoding the token
Similarly, `decode_token()` function decodes the token, it takes *token* as an argument and returns the *payload*.
```python
def decode_token(token):
    public_keys = {}
    with open('jwks.json', 'r') as f:
        public_k = json.load(f)   
    key = jwt.algorithms.RSAAlgorithm.from_jwk(public_k["keys"])
    payload = jwt.decode(token, key, algorithms=['RS256'])
    return payload
```
### JWK and JWKS

For **JSON Web Key Sets(JWKS)** we have the following endpoint.
` http://localhost:5000/jwks`
The user must provide the token in the header to get the JWKS. The response of this endpoint is 
```
{
    "keys": {
        "alg": "RSA",
        "e": "AQAB",
        "kid": "12345",
        "kty": "RSA",
        "n": "znzjcDpdgJ-9bHH3KlDYoFMMsljvb8ZWjN4XXtK2nD8zmnpZDs7XVLlykS4opHClAlpIneXnDYTZswjLwyr_4z72Mp6nIZHpgkZ9t8fozgUJbNmwCZwGNCdBScCSwO67tefdeUHRq3-2ZqOCWJC8X6UfhAgcJQIBgJpQljZ9HTcbcnRrTymkzMd19VLC3hncoL9KSfZ2NH-lmUwLZv4FQXMfjlKPDp-fsc2TCKYAToLFAUAWVPfQMhTEJlrFF19ykYsBDyg-M83Onz_h1z40q0-ihEovWmGgkzet6Q5OgqKT7JPdkOr-f-GT4RhFuLV5aMoVyYpUJiuljt8M6MMUZw",
        "use": "enc"
    }
}
```

It contains a set of JWK which is used to decode the token and retrive the message.

## Refrences

[PyJwt Documentation](https://pyjwt.readthedocs.io/en/latest/usage.html)
[PyCrypto's Documentation](https://pycrypto.readthedocs.io/en/latest/)

---
**NOTE**


---